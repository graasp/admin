import{cM as f,cN as U,gv as N,r as l,j as u,s as y}from"./index-B_BHgQQY.js";import{w as G,b as m,i as w,a as I}from"./withResizing-Bmu3xIGc.js";import{S as R}from"./constants-CyQbYbhY.js";import{g as M}from"./appItem-PW1ezbEO.js";import{a as b}from"./url-DDYejV_U.js";import{S as H}from"./Skeleton-Bf_dEhrE.js";const J=async s=>{const{id:n,key:o,origin:e}=s;return f.post(`${U}/${N(n)}`,{origin:e,key:o}).then(({data:E})=>E)},d=s=>({GET_CONTEXT_SUCCESS:`GET_CONTEXT_SUCCESS_${s}`,GET_CONTEXT_FAILURE:`GET_CONTEXT_FAILURE_${s}`,GET_CONTEXT:`GET_CONTEXT_${s}`,GET_AUTH_TOKEN:`GET_AUTH_TOKEN_${s}`,GET_AUTH_TOKEN_SUCCESS:`GET_AUTH_TOKEN_SUCCESS_${s}`,GET_AUTH_TOKEN_FAILURE:`GET_AUTH_TOKEN_FAILURE_${s}`,POST_AUTO_RESIZE:`POST_AUTO_RESIZE_${s}`,POST_MAX_RESIZE:`POST_MAX_RESIZE_${s}`}),x=({item:s,contextPayload:n,appUrl:o,iFrameRef:e,requestApiAccessToken:E})=>{l.useEffect(()=>{const g=S=>async T=>{const{data:c,origin:a}=T,r=d(s.id);if(o?.includes(a))try{const{type:i,payload:t}=JSON.parse(c);switch(i){case r.GET_AUTH_TOKEN:{S.postMessage(JSON.stringify({type:r.GET_AUTH_TOKEN_SUCCESS,payload:await E({id:s.id,...t})}));break}case r.POST_AUTO_RESIZE:{if(s.settings.isResizable||e.current===null||typeof t!="number")return;e.current.style.height=`${t}px`;break}case r.POST_MAX_RESIZE:{if(s.settings.isResizable||e.current===null)return;e.current.style.height="100vh";break}}}catch{console.debug("App sent message that could not be parsed",c)}},_=S=>{const{data:T,origin:c}=S,a=d(s.id);if(o?.includes(c))try{const{type:r}=JSON.parse(T);if(r===a.GET_CONTEXT){const i=new MessageChannel,{port1:t}=i;t.onmessage=g(t);const A=new URL(o).origin;e?.current?.contentWindow?.postMessage(JSON.stringify({type:a.GET_CONTEXT_SUCCESS,payload:{memberId:n.accountId,...n}}),A,[i.port2])}}catch{console.debug("App sent message that could not be parsed",T)}};return window.addEventListener("message",_),()=>window.removeEventListener("message",_)},[s,e])},P=y("iframe")(({isResizable:s,height:n})=>({...w,height:s?"100%":n,width:"100%"})),X=400,$="ts",K=({item:s,contextPayload:n,requestApiAccessToken:o,height:e,frameId:E,memberId:g,isResizable:_=!1,showCaption:S=!0,showCollapse:T=!1,onCollapse:c})=>{const[a,r]=l.useState(!0),i=l.useRef(null),t=M(s.extra)?.url||"";x({item:s,appUrl:t,iFrameRef:i,contextPayload:n,requestApiAccessToken:o});const A=()=>r(!1),h=l.useMemo(()=>b(t,{itemId:s.id,[$]:Date.now().toString()}),[s]),O=u.jsx(P,{"data-testid":E,id:E,ref:i,isResizable:_,onLoad:A,src:h,sx:{visibility:a?"hidden":"visible"},title:s?.name,height:e??"80vh",allow:"fullscreen"}),C=G({height:e??X,memberId:g,itemId:s.id,component:O});let p=u.jsxs(u.Fragment,{children:[a&&u.jsx(H,{variant:"rectangular",width:"100%",height:R}),_?u.jsx(C,{}):O]});return S&&(p=I({item:s})(p)),T&&(p=m({item:s,onCollapse:c})(p)),p},q=l.memo(K);export{q as A,J as r};
